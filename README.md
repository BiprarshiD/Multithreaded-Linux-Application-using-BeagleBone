**Advanced Embedded Software Development (AESD) – ECEN 5013 – Project 1**

**Author -Souvik De, Devansh Mittal**

**Multi-threaded BeagleBone Linux application having sensor interface, logger
and sockets.** Project Link: https://devmittal.github.io/devamitt.github.io/index.html

This project is a multi-threaded C application which interacts with a
temperature and light sensor simultaneously and continuously logs the values in
a log file.

The main task spawns 4 threads:

-   Temperature sensor thread which is responsible for interacting with the
    TMP102 temperature sensor over MT-safe I2C

-   Light sensor thread which is responsible for interacting with the APDs9301
    light sensor over MT-safe I2C

-   Logger thread which is responsible for logging sensor values, errors and
    sensor status.

-   Remote thread which runs a TCP server and accepts connections from clients
    with various requests like temperature value and lux value

Sanity Checks:

-   Start up tests for each sensor

-   Regular monitoring and logging of status of each thread (heartbeat check).

-   Unit Tests.

If any of the 2 sensors fail or are stuck for more than a timeout, the main task
gracefully closes that thread. If the logger thread fails, the main task closes
all the threads and gracefully exits the program. Any failure is indicated by an
LED on the BeagleBone.

Functions and their descriptions:

**i2c.h**

init_i2c: This function initializes the I2C bus

write_i2c: This function writes 8-bit data to the I2C Bus

write_i2c16: This function writes 16-bit data to the I2C Bus

read_i2c16: This function reads 16-bit data from the I2C Bus

read_i2c8: This function reads 8-bit data from the I2C Bus

close_i2c: This function concludes the I2C Communication.

write_i2c16_config: This function writes 24-bit data to the I2C Bus to write to
the configuration register of the temperature sensor.

**led.h**

led: This function switches the LED on and off

**lightSensor.h**

startup_test: This function checks the identification register as part of a
startup test and confirms if the light sensor is working properly.

power_up: This function powers up the light sensor.

read_control_register: This function reads control register of the light sensor.

set_timing_register: This function is used to set the integration time and gain
of light sensor.

read_timing_register: This function reads timing register of the light sensor.

enable_interrupt: This function enables interrupts in the interrupt control
register of the light sensor.

disable_interrupt: This function disable interrupts of the light sensor.

set_interrupt_threshold: This function sets the high and low interrupt threshold
of the light sensor.

read_interrupt_threshold: This function reads the high and low interrupt
threshold of the light sensor.

read_visible_light: This function reads channel 0 of light sensor.

read_IR_light: This function reads channel 1 of light sensor.

cal_lumen: This function calculates actual luminosity based on channel 0 and
channel 1 lux values of light sensor.

change: This function checks if there is any change in light state from the
previous state.

state: This function determines current light state based on threshold value.

read_LightSensor: This function calls functions to read channel 0 and 1,
calculate lumen, determine current light state, and if there was a change from
previous state and stores it in the allocated structure.

**logger.h**

write_log: This function logs events, errors, and heartbeat notifications
generated by the program

**message.h**

init_MessageQueues: This function initializes all the message queues

dest_MessageQueues: This function destroys (closes and unlinks) all the message
queues

open_MessageQueue: This function opens a message queue identified by its
parameters

send_Message: This function is used to send messages through a queue identified
by the first parameter

recv_Message: This function is used to receive messages through a queue
identified by the first parameter

CloseUnlinkQueue: This function closes and unlinks a message queue identified by
the first parameter

**remoteTask.h**

init_socket: This function initializes the socket at the server side

send_data: This function sends data through a socket from server to client

read_data: This function reads data sent from client to server via a socket

**temperature.h**

read_temperature: This function reads the temperature register of the
temperature sensor

cal_temp: This function calculates actual temperature in celsius, fahrenheit,
and kelvin based on digital temperature values read from the temperature
register

read_Tlow: This function reads the lower temperature limit from the tlow
register of the temperature sensor.

read_Thigh: This function reads the higher temperature limit from the thigh
register of the temperature sensor

read_configuration_reg: This function reads the configuration register of the
temperature sensor

set_shutdown: This function sets the shutdown mode in the configuration register
of the temperature register

disable_shutdown: This function disables the shutdown mode in the configuration
register of the temperature register

read_fault: This function reads the fault bits from the configuration register
of the temperature register

read_em: This function reads the extended mode bit in the configuration register
of the temperature register.

write_em: This function sets/disables the extended mode in the configuration
register of the temperature register

read_conversion_rate: This function reads the conversion rate bits in the
configuration register of the temperature register

set_conversion_rate: This function sets the conversion rate bits in the
configuration register of the temperature register

write_fault: This function sets the fault bits in the configuration register of
the temperature register

**clientprocess.h**

init_socket: This function initializes the socket at the client side

send_data: This function sends data through a socket from client to server

read_data: This function reads data sent from server to client via a socket

**main.c**

kill_signal_handler: Signal handler for signal SIGINT aka Ctrl-C

getSensorData: Common call back function for temperature and light timer

timer_init: This function initializes a unique timer on demand for every
requesting thread

temperature: Temperature thread callback function

light: Light thread callback function

logger: Logger thread callback function

remote: Remote task thread callback function

check_heartbeat: This function registers heart beats from different threads and
sends relevant data to the logger.

setup_signalhandler: This function initialize a signal handler to kill any
particular thread or the process itself.

Unit Tests

**Light Sensor Task**

Start-up Test: Read ID register to verify light sensor is functional

Power-up Test: Read Control register to verify that light sensor has powered up

Timing Register Test: Set random integration and gain values and check if it is
writing to the register by reading it.

Lumen Calculation Test: With random channel 0 and channel 1 lux values, the
lumen calculation formula is tested to see if we are getting correct luminosity.

**Temperature Sensor Task**

Temperature Calculation Test: With random digital temperature values, it is
tested whether the correct temperature values in Celsius, Fahrenheit and Kelvin
are obtained.

Tlow Register Test: The Tlow register is read to test if the default value of 75
Celsius is obtained.

Thigh Register Test: The Thigh register is read to test if the default value of
80 Celsius is obtained.

Configuration Register Test: The configuration register is read to test if the
default value of 0x60A0 is obtained.

**Logger Task**

File Creation Test: The function which creates the file is called to test if the
file is created without any errors.

Start-up Tests

**Light Sensor Task**: The ID register is read and then checked if it correctly
equals 0x50.

**Temperature Sensor Task**: The configuration register is read and checked if
it correctly equals the default value of 0x60A0.

**Logger Task**: The start-up test constitutes the logger thread spawning and a
file being created.
